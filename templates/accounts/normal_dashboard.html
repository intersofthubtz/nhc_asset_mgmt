{% extends "base.html" %}
{% block content %}

<div class="w-full max-w-7xl mx-auto mt-6 px-4 sm:px-6 lg:px-8">

  <!-- HEADER -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div>
      <h2 class="text-2xl sm:text-3xl font-bold text-nhc-blue tracking-tight">
        User Dashboard
      </h2>
      <p class="text-gray-700 mt-1">
        Welcome, <span class="font-semibold text-nhc-blue">{{ user.username }}</span>!
        Track and manage your borrow requests.
      </p>
    </div>

    <!-- NEW REQUEST BUTTON -->
    <a href="javascript:void(0)"
       onclick="openModal()"
       class="bg-nhc-yellow hover:bg-yellow-500 text-nhc-black font-semibold px-4 py-2 rounded-lg shadow-md transition">
      + Make New Request
    </a>
  </div>

  <!-- STATS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h5 class="text-xl font-bold text-nhc-blue mb-1">Pending</h5>
      <p class="text-gray-600 text-sm mb-2">Awaiting approval</p>
      <span class="bg-yellow-400 text-black px-4 py-1 rounded-full font-semibold text-lg">
        {{ pending_requests_count|default:"0" }}
      </span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h5 class="text-xl font-bold text-nhc-blue mb-1">Approved</h5>
      <p class="text-gray-600 text-sm mb-2">Approved requests</p>
      <span class="bg-green-500 text-white px-4 py-1 rounded-full font-semibold text-lg">
        {{ approved_requests_count|default:"0" }}
      </span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h5 class="text-xl font-bold text-nhc-blue mb-1">Rejected</h5>
      <p class="text-gray-600 text-sm mb-2">Rejected requests</p>
      <span class="bg-red-600 text-white px-4 py-1 rounded-full font-semibold text-lg">
        {{ rejected_requests_count|default:"0" }}
      </span>
    </div>

  </div>

  <!-- SEARCH & FILTERS (STAFF DESIGN REUSED) -->
  <form id="searchForm" method="get"
        class="flex flex-col sm:flex-row items-center justify-between gap-3 mb-5 bg-white p-4 rounded-lg shadow-md border border-gray-100">

    <!-- SEARCH -->
    <div class="w-full sm:w-1/2">
      <input type="text" name="search" value="{{ search_query }}"
             placeholder="Search by category or remarks..."
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-nhc-blue transition shadow-sm">
    </div>

    <!-- FILTERS -->
    <div class="flex gap-3 w-full sm:w-auto flex-wrap">

      <select name="status"
              class="px-4 py-2 border border-gray-300 rounded-lg w-full sm:w-44">
        <option value="all">All Status</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
      </select>

      <select name="category"
              class="px-4 py-2 border border-gray-300 rounded-lg w-full sm:w-44">
        <option value="all">All Categories</option>
        <option value="laptop" {% if category_filter == 'laptop' %}selected{% endif %}>Laptop</option>
        <option value="projector" {% if category_filter == 'projector' %}selected{% endif %}>Projector</option>
        <option value="desktop" {% if category_filter == 'desktop' %}selected{% endif %}>Desktop</option>
      </select>

    </div>
  </form>

  <!-- REQUESTS TABLE -->
  <div class="overflow-x-auto bg-white shadow-md rounded-none">
    <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">

      <thead class="bg-gray-200 text-nhc-black uppercase font-semibold">
        <tr>
          <th class="py-3 px-4 text-left">Asset Category</th>
          <th class="py-3 px-4 text-left">Request Date</th>
          <th class="py-3 px-4 text-left">Return Date</th>
          <th class="py-3 px-4 text-left">Status</th>
          <th class="py-3 px-4 text-left">Remarks</th>
          <th class="py-3 px-4 text-center">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        {% for r in page_obj %}
        <tr class="hover:bg-gray-50 transition">

          <td class="py-3 px-4 font-semibold text-nhc-blue">
            {{ r.asset_category }}
          </td>

          <td class="py-3 px-4">{{ r.request_date }}</td>
          <td class="py-3 px-4">{{ r.return_date }}</td>

          <td class="py-3 px-4">
            {% if r.status == "pending" %}
              <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-semibold">
                Pending
              </span>
            {% elif r.status == "approved" %}
              <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">
                Approved
              </span>
            {% elif r.status == "rejected" %}
              <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">
                Rejected
              </span>
            {% elif r.status == "cancelled" %}
              <span class="px-3 py-1 rounded-full bg-gray-200 text-gray-600 font-semibold">
                Cancelled
              </span>
            {% endif %}
          </td>

          <td class="py-3 px-4">{{ r.remarks|default:"—" }}</td>

          <td class="py-3 px-4 text-center">
            {% if r.status == "pending" %}
              <a href="{% url 'requests:cancel_request' r.pk %}"
                 onclick="return confirm('Are you sure you want to cancel this request?')"
                 class="text-red-600 hover:text-red-800 font-semibold">
                Cancel
              </a>
            {% else %}
              <span class="text-gray-400">—</span>
            {% endif %}
          </td>

        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="py-8 text-center text-gray-500">
            No requests found.
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  <!-- PAGINATION -->
  {% if page_obj.has_other_pages %}
  <nav class="flex justify-center items-center mt-6 gap-2">

    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}"
         class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black">
        Previous
      </a>
    {% else %}
      <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">
        Previous
      </span>
    {% endif %}

    <span class="px-4 py-2 bg-nhc-yellow text-nhc-black rounded-md font-semibold">
      {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}"
         class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black">
        Next
      </a>
    {% else %}
      <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">
        Next
      </span>
    {% endif %}

  </nav>
  {% endif %}

</div>

<!-- MODAL -->
<div id="requestModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">

  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 relative">
    <button onclick="closeModal()"
            class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl">&times;</button>

    <h3 class="text-2xl font-bold text-nhc-blue mb-4">Make New Request</h3>

    <form method="POST" action="{% url 'requests:make_request' %}">
      {% csrf_token %}

      <label class="block font-semibold mb-1">Asset Category</label>
      <select name="asset_category" class="w-full border p-2 rounded mb-3" required>
        <option disabled selected>Select Category</option>
        <option value="laptop">Laptop</option>
        <option value="projector">Projector</option>
        <option value="desktop">Desktop</option>
      </select>

      <label class="block font-semibold mb-1">Request Date</label>
      <input type="date" name="request_date" class="w-full border p-2 rounded mb-3" required>

      <label class="block font-semibold mb-1">Return Date</label>
      <input type="date" name="return_date" class="w-full border p-2 rounded mb-4" required>

      <button class="w-full bg-nhc-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
        Submit Request
      </button>
    </form>
  </div>
</div>

<!-- JS -->
<script>
  function openModal() {
    document.getElementById("requestModal").classList.remove("hidden");
    document.getElementById("requestModal").classList.add("flex");
  }

  function closeModal() {
    document.getElementById("requestModal").classList.add("hidden");
    document.getElementById("requestModal").classList.remove("flex");
  }

  const searchInput = document.querySelector('input[name="search"]');
  const statusSelect = document.querySelector('select[name="status"]');
  const categorySelect = document.querySelector('select[name="category"]');
  const searchForm = document.getElementById('searchForm');
  let typingTimer;

  searchInput.addEventListener('keyup', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => searchForm.submit(), 500);
  });

  searchInput.addEventListener('keydown', () => clearTimeout(typingTimer));
  statusSelect.addEventListener('change', () => searchForm.submit());
  categorySelect.addEventListener('change', () => searchForm.submit());
</script>

{% endblock %}
