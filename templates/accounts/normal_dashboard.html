{% extends "base.html" %}
{% block content %}

<div class="w-full max-w-6xl mx-auto mt-10 px-4 sm:px-6 lg:px-8">

  <!-- HEADER -->
  <div class="mb-6 flex justify-between items-center">
    <div>
      <h2 class="text-3xl font-bold text-nhc-blue">User Dashboard</h2>
      <p class="text-gray-700 mt-1">
        Welcome, <span class="font-semibold text-nhc-blue">{{ user.username }}</span>!
        Manage your borrow requests and submit new ones.
      </p>
    </div>

    <!-- OPEN MODAL BUTTON -->
    <a href="javascript:void(0)"
       onclick="openModal()"
       class="bg-nhc-yellow hover:bg-yellow-500 text-nhc-black font-semibold px-4 py-2 rounded-lg shadow-md transition">
      + Make New Request
    </a>
  </div>

  <!-- STAT CARDS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
      <h5 class="text-xl font-bold text-nhc-blue mb-2">Pending Requests</h5>
      <p class="text-gray-600 text-sm mb-3">Requests awaiting approval</p>
      <span class="bg-nhc-yellow text-nhc-black px-4 py-1 rounded-full font-semibold text-lg">
        {{ pending_requests_count|default:"0" }}
      </span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
      <h5 class="text-xl font-bold text-nhc-blue mb-2">Approved Requests</h5>
      <p class="text-gray-600 text-sm mb-3">Requests that have been approved</p>
      <span class="bg-green-500 text-white px-4 py-1 rounded-full font-bold text-lg">
        {{ approved_requests_count|default:"0" }}
      </span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
      <h5 class="text-xl font-bold text-nhc-blue mb-2">Rejected Requests</h5>
      <p class="text-gray-600 text-sm mb-3">Requests that have been rejected</p>
      <span class="bg-red-600 text-white px-4 py-1 rounded-full font-bold text-lg">
        {{ rejected_requests_count|default:"0" }}
      </span>
    </div>

  </div>

  <!-- FILTER BAR -->
  <div class="flex flex-wrap gap-3 mb-4">

    <!-- SEARCH -->
    <input id="searchInput" type="text"
           placeholder="Search requests..."
           class="border p-2 rounded-lg">

    <!-- STATUS FILTER -->
    <select id="statusFilter" class="border p-2 rounded-lg">
      <option value="">All Status</option>
      <option value="pending">Pending</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>

    <!-- CATEGORY FILTER -->
    <select id="categoryFilter" class="border p-2 rounded-lg">
      <option value="">All Categories</option>
      <option value="laptop">Laptop</option>
      <option value="projector">Projector</option>
      <option value="desktop">Desktop</option>
    </select>

  </div>

  <!-- REQUEST TABLE -->
  <div class="bg-white shadow-md rounded-xl overflow-hidden border border-gray-200">

    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Category / Asset</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Request Date</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Return Date</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Status</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Remarks</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        {% for r in requests %}
          <tr>
            <td class="px-6 py-4">
              {% if r.assigned_asset %}
                {{ r.asset_category }}
              {% else %}
                {{ r.asset_category }}
              {% endif %}
            </td>

            <td class="px-6 py-4">{{ r.request_date }}</td>

            <td class="px-6 py-4">{{ r.return_date }}</td>

            <td class="px-6 py-4 capitalize">
              {% if r.status == "pending" %}
                <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">Pending</span>
              {% elif r.status == "approved" %}
                <span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Approved</span>
              {% else %}
                <span class="bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">Rejected</span>
              {% endif %}
            </td>

            <td class="px-6 py-4">{{ r.remarks|default:"-" }}</td>
          </tr>

        {% empty %}
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
              You have not made any requests yet.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <!-- PAGINATION -->
  <div class="flex justify-center space-x-3 mt-6">

    {% if requests.has_previous %}
      <a href="?page={{ requests.previous_page_number }}"
         class="px-4 py-2 bg-gray-200 rounded">Previous</a>
    {% endif %}

    <span class="px-4 py-2 bg-gray-300 rounded">
      Page {{ requests.number }} of {{ requests.paginator.num_pages }}
    </span>

    {% if requests.has_next %}
      <a href="?page={{ requests.next_page_number }}"
         class="px-4 py-2 bg-gray-200 rounded">Next</a>
    {% endif %}

  </div>

</div>

<!-- MODAL FORM -->
<div id="requestModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">

  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 relative">

    <button onclick="closeModal()"
            class="absolute top-3 right-3 text-gray-600 hover:text-black text-xl">&times;</button>

    <h3 class="text-2xl font-bold text-nhc-blue mb-4">Make New Request</h3>

    <form id="newRequestForm" method="POST" action="{% url 'requests:make_request' %}">
      {% csrf_token %}

      <!-- CATEGORY -->
      <label class="block font-semibold mb-1">Asset Category</label>
      <select name="asset_category" class="w-full border p-2 rounded mb-3" required>
        <option value="" disabled selected>Select Category</option>
        <option value="laptop">Laptop</option>
        <option value="projector">Projector</option>
        <option value="desktop">Desktop</option>
      </select>

      <!-- REQUEST -->
      <label class="block font-semibold mb-1">Request Date</label>
      <input type="date" name="request_date"
             class="w-full border p-2 rounded mb-4" required> 

      <!-- RETURN -->
      <label class="block font-semibold mb-1">Return Date</label>
      <input type="date" name="return_date"
             class="w-full border p-2 rounded mb-4" required>

      <button type="submit"
              class="w-full bg-nhc-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
        Submit Request
      </button>

    </form>

  </div>
</div>

<!-- JAVASCRIPT -->
<script>
function openModal() {
  const m = document.getElementById("requestModal");
  m.classList.remove("hidden");
  m.classList.add("flex");
}

function closeModal() {
  const m = document.getElementById("requestModal");
  m.classList.add("hidden");
  m.classList.remove("flex");
}

/* FILTER HANDLING */
function applyFilters() {
  let search = document.getElementById("searchInput").value;
  let status = document.getElementById("statusFilter").value;
  let category = document.getElementById("categoryFilter").value;

  let url = new URL(window.location.href);

  search ? url.searchParams.set("search", search) : url.searchParams.delete("search");
  status ? url.searchParams.set("status", status) : url.searchParams.delete("status");
  category ? url.searchParams.set("category", category) : url.searchParams.delete("category");

  window.location.href = url;
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
</script>

{% endblock %}
