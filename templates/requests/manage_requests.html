{% comment %} {% extends "accounts/staff_dashboard.html" %}
{% block staff_content %}
<div class="w-full max-w-7xl mx-auto mt-6 px-4 sm:px-6 lg:px-8">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div>
      <h2 class="text-2xl sm:text-3xl font-bold text-nhc-blue tracking-tight">Manage Requests</h2>
      <p class="text-gray-600 mt-1 text-sm sm:text-base">
        {{ page_obj.paginator.count }} requests in the system
      </p>
    </div>
  </div>

  <!-- Search & Filter (Always visible) -->
  <form method="get" class="flex flex-col sm:flex-row items-center justify-between gap-3 mb-5 bg-white p-4 rounded-lg shadow-md border border-gray-100">
    <input
      type="text"
      name="search"
      value="{{ search_query }}"
      placeholder="Search by user, asset, or status..."
      class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-nhc-yellow focus:border-transparent shadow-sm transition"
    >
    
    <select name="status"
            onchange="this.form.submit()"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-nhc-yellow focus:border-transparent transition shadow-sm w-full sm:w-44">
      <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
      <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
      <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
      <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
    </select>
  </form>

  <!-- Requests Table -->
  <div class="overflow-x-auto bg-white shadow-md rounded-lg border border-gray-100">
    <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">
      <!-- Table Head: Always visible -->
      <thead class="bg-gray-200 text-nhc-black uppercase font-semibold select-none">
        <tr>
          <th class="py-3 px-4 text-left">ID</th>
          <th class="py-3 px-4 text-left">User</th>
          <th class="py-3 px-4 text-left">Asset</th>
          <th class="py-3 px-4 text-left">Request Date</th>
          <th class="py-3 px-4 text-left">Return Date</th>
          <th class="py-3 px-4 text-left">Status</th>
          <th class="py-3 px-4 text-left">Approval Date</th>
          <th class="py-3 px-4 text-left">Approved By</th>
          <th class="py-3 px-4 text-left">Remarks</th>
          <th class="py-3 px-4 text-center">Action</th>
        </tr>
      </thead>

      <!-- Table Body -->
      <tbody class="divide-y divide-gray-100">
        {% if all_requests %}
          {% for req in all_requests %}
          <tr class="hover:bg-gray-50 transition duration-150">
            <td class="py-3 px-4">{{ req.id }}</td>
            <td class="py-3 px-4 font-semibold text-nhc-blue">{{ req.user.username }}</td>
            <td class="py-3 px-4">{{ req.asset.asset_name }}</td>
            <td class="py-3 px-4">{{ req.request_date|date:"M d, Y" }}</td>
            <td class="py-3 px-4">{{ req.return_date|date:"M d, Y" }}</td>
            <td class="py-3 px-4">
              <span class="inline-block px-3 py-1 text-xs sm:text-sm font-semibold rounded-full
                {% if req.status == 'approved' %}bg-green-100 text-green-700
                {% elif req.status == 'rejected' %}bg-red-100 text-red-700
                {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                {{ req.get_status_display }}
              </span>
            </td>
            <td class="py-3 px-4">
              {% if req.approval_date %}
                {{ req.approval_date|date:"M d, Y H:i" }}
              {% else %}
                <span class="text-gray-400 italic">—</span>
              {% endif %}
            </td>
            <td class="py-3 px-4">
              {% if req.approved_by %}
                {{ req.approved_by.username }}
              {% else %}
                <span class="text-gray-400 italic">—</span>
              {% endif %}
            </td>
            <td class="py-3 px-4 text-gray-600 text-sm">
              {% if req.remarks %}
                {{ req.remarks }}
              {% else %}
                <span class="text-gray-400 italic">—</span>
              {% endif %}
            </td>
            <td class="py-3 px-4 text-center">
              {% if req.status == 'pending' %}
              <div class="flex justify-center gap-2">
                <button onclick="openActionModal({{ req.pk }}, 'approve')"
                  class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md transition text-xs sm:text-sm">
                  Approve
                </button>
                <button onclick="openActionModal({{ req.pk }}, 'reject')"
                  class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition text-xs sm:text-sm">
                  Reject
                </button>
              </div>
              {% else %}
                <span class="text-gray-400 text-sm italic">No action</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <!-- Always keep table head visible, show "not found" row -->
          <tr>
            <td colspan="10" class="text-center text-gray-500 py-4">No asset requests available at the moment.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
  <div class="flex justify-center mt-6">
    <nav class="inline-flex items-center space-x-1">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}"
           class="px-3 py-1 border rounded-md bg-white text-gray-600 hover:bg-nhc-yellow hover:text-white transition">
          ‹ Prev
        </a>
      {% else %}
        <span class="px-3 py-1 border rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">‹ Prev</span>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <span class="px-3 py-1 border rounded-md bg-nhc-blue text-white font-semibold">{{ num }}</span>
        {% else %}
          <a href="?page={{ num }}&search={{ search_query }}&status={{ status_filter }}"
             class="px-3 py-1 border rounded-md bg-white text-gray-600 hover:bg-nhc-yellow hover:text-white transition">
            {{ num }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}"
           class="px-3 py-1 border rounded-md bg-white text-gray-600 hover:bg-nhc-yellow hover:text-white transition">
          Next ›
        </a>
      {% else %}
        <span class="px-3 py-1 border rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">Next ›</span>
      {% endif %}
    </nav>
  </div>
  {% endif %}

  <!-- Action Modal -->
  <div id="actionModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-start justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md p-6 mt-10 transform scale-100 transition-all duration-200">
      <h3 class="text-lg font-semibold text-nhc-blue mb-4" id="modalTitle"></h3>
      <form method="POST" id="actionForm">
        {% csrf_token %}
        <div class="mb-4">
          <label for="remarks" class="block text-gray-700 font-medium">Remarks (optional)</label>
          <textarea name="remarks" id="remarks" rows="3"
            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-nhc-yellow focus:border-nhc-yellow focus:outline-none transition"></textarea>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeActionModal()" 
            class="px-4 py-2 rounded-md bg-gray-300 hover:bg-gray-400 transition">Cancel</button>
          <button type="submit" 
            class="px-4 py-2 rounded-md bg-nhc-blue text-white hover:bg-nhc-black transition" 
            id="modalSubmitBtn">Confirm</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
function openActionModal(requestId, action) {
  const modal = document.getElementById('actionModal');
  const title = document.getElementById('modalTitle');
  const form = document.getElementById('actionForm');
  const submitBtn = document.getElementById('modalSubmitBtn');

  modal.classList.remove('hidden');
  title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} Request`;
  form.action = `/accounts/staff/staff/request/${requestId}/${action}/`;
  submitBtn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
}

function closeActionModal() {
  document.getElementById('actionModal').classList.add('hidden');
  document.getElementById('remarks').value = '';
}

window.addEventListener('click', e => {
  const modal = document.getElementById('actionModal');
  if (!modal.classList.contains('hidden') && e.target === modal) closeActionModal();
});
</script>
{% endblock %} {% endcomment %}
