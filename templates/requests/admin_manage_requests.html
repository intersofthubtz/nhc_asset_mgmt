{% extends "accounts/admin_dashboard.html" %}
{% block admin_content %}
<div class="w-full max-w-7xl mx-auto mt-6 px-4 sm:px-6 lg:px-8">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div>
      <h2 class="text-2xl sm:text-3xl font-bold text-nhc-blue tracking-tight">Manage Asset Requests</h2>
    </div>
  </div>

  <!-- Search & Filters -->
  <form id="searchForm" method="get"
        class="flex flex-col sm:flex-row items-center justify-between gap-3 mb-5 bg-white p-4 rounded-lg shadow-md border border-gray-100">

    <!-- Search Input -->
    <div class="w-full sm:w-1/2">
      <input type="text" name="search" value="{{ search_query }}" placeholder="Search by user or category..."
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-nhc-blue focus:border-transparent transition shadow-sm">
    </div>

    <!-- Filters -->
    <div class="flex gap-3 w-full sm:w-auto flex-wrap">

      <select name="status"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-nhc-blue focus:border-transparent transition shadow-sm w-full sm:w-44">
        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
        <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
        <option value="Approved" {% if status_filter == 'Approved' %}selected{% endif %}>Approved</option>
        <option value="Rejected" {% if status_filter == 'Rejected' %}selected{% endif %}>Rejected</option>
      </select>

    </div>
  </form>

  <!-- TABLE: REQUESTS -->
  <div class="overflow-x-auto bg-white shadow-md rounded-none">
    <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">
      <thead class="bg-gray-200 text-nhc-black uppercase font-semibold">
        <tr>
          <th class="py-3 px-4 text-left">Requested By</th>
          <th class="py-3 px-4 text-left">Category</th>
          <th class="py-3 px-4 text-left">Request Date</th>
          <th class="py-3 px-4 text-left">Return Date</th>
          <th class="py-3 px-4 text-left">Assigned Asset</th>
          <th class="py-3 px-4 text-left">Status</th>
          <th class="py-3 px-4 text-center">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        {% for req in page_obj %}
        <tr class="hover:bg-gray-50 transition duration-150">

          <td class="py-3 px-4 font-semibold text-nhc-blue">
            {{ req.user.get_full_name|default:req.user.username }}
          </td>

          <td class="py-3 px-4">
            {{ req.asset_category }}
          </td>

          <td class="py-3 px-4">
            {{ req.request_date }}
          </td>

          <td class="py-3 px-4">
            {{ req.return_date|default:"â€”" }}
          </td>

          <td class="py-3 px-4">
            {% if req.assigned_asset_id %}
              <span class="text-green-700 font-semibold">
                Asset #{{ req.assigned_asset_id }}
              </span>
            {% else %}
              <span class="text-gray-500">Not Assigned</span>
            {% endif %}
          </td>

          <td class="py-3 px-4">
            <span class="inline-flex items-center px-3 py-1 font-semibold rounded-full
              {% if req.status == 'Pending' %}bg-yellow-100 text-yellow-700
              {% elif req.status == 'Approved' %}bg-blue-100 text-blue-700
              {% elif req.status == 'Rejected' %}bg-gray-100 text-gray-700{% endif %}">
              {{ req.status }}
            </span>
          </td>

          <!-- ACTION BUTTONS -->
          <td class="py-3 px-4 text-center flex justify-center gap-3">

            <!-- VIEW DETAILS -->
            <a href="{% url 'requests:admin_get_request_details' req.pk %}"
               class="text-gray-600 hover:text-gray-800" title="View Details">
              <i class="fas fa-eye"></i>
            </a>

            <!-- APPROVE -->
            {% if req.status == 'Pending' %}
            <a href="{% url 'requests:admin_update_request_status' req.pk 'approve' %}"
               class="text-green-600 hover:text-green-800" title="Approve">
              <i class="fas fa-check-circle"></i>
            </a>

            <!-- REJECT -->
            <a href="{% url 'requests:admin_update_request_status' req.pk 'reject' %}"
               class="text-red-600 hover:text-red-800" title="Reject">
              <i class="fas fa-times-circle"></i>
            </a>
            {% endif %}

          </td>

        </tr>

        {% empty %}
        <tr>
          <td colspan="7" class="py-8 text-center text-gray-500">No requests found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav class="flex justify-center items-center mt-6 gap-2 text-sm sm:text-base">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}"
           class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">Previous</a>
      {% else %}
        <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">Previous</span>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
          {% if num == page_obj.number %}
            <span class="px-4 py-2 bg-nhc-yellow text-nhc-black rounded-md font-semibold shadow">{{ num }}</span>
          {% else %}
            <a href="?page={{ num }}&search={{ search_query }}&status={{ status_filter }}"
               class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">{{ num }}</a>
          {% endif %}
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}"
           class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">Next</a>
      {% else %}
        <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">Next</span>
      {% endif %}
    </nav>
  {% endif %}
</div>

<!-- JS: Auto-submit Search/Filters -->
<script>
  const searchInput = document.querySelector('input[name="search"]');
  const statusSelect = document.querySelector('select[name="status"]');
  const searchForm = document.getElementById('searchForm');

  let typingTimer;
  const delay = 600;

  searchInput.addEventListener('keyup', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => searchForm.submit(), delay);
  });

  searchInput.addEventListener('keydown', () => clearTimeout(typingTimer));

  statusSelect.addEventListener('change', () => searchForm.submit());
</script>

{% endblock %}
