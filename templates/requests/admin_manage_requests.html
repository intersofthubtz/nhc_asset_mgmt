{% extends "accounts/admin_dashboard.html" %}
{% block admin_content %}
<h2 class="text-2xl font-bold text-nhc-blue mb-3">Manage Requests</h2>

{% if all_requests %}
<!-- Search & Filters -->
<form method="get" class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 w-full">

  <!-- Search Input -->
  <input
    type="text"
    name="search"
    value="{{ search_query }}"
    placeholder="Search by user, asset, or status..."
    class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nhc-yellow"
    oninput="this.form.submit()"
  />

  <!-- Status Filter -->
  <div class="flex items-center gap-2">
    <select
      name="status"
      class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-nhc-yellow"
      onchange="this.form.submit()"
    >
      <option value="all" {% if status_filter == "all" %}selected{% endif %}>All</option>
      <option value="pending" {% if status_filter == "pending" %}selected{% endif %}>Pending</option>
      <option value="approved" {% if status_filter == "approved" %}selected{% endif %}>Approved</option>
      <option value="rejected" {% if status_filter == "rejected" %}selected{% endif %}>Rejected</option>
    </select>
  </div>
</form>

<!-- Requests Table -->
<div class="overflow-x-auto bg-white shadow-md rounded-none">
  <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base" id="requestsTable">
    <thead class="bg-gray-200 text-nhc-black uppercase font-semibold select-none">
      <tr>
        <th class="py-3 px-4 text-left">User</th>
        <th class="py-3 px-4 text-left">Asset</th>
        <th class="py-3 px-4 text-left">Model</th>
        <th class="py-3 px-4 text-left">Requested</th>
        <th class="py-3 px-4 text-left">Return</th>
        <th class="py-3 px-4 text-left">Status</th>
        <th class="py-3 px-4 text-left">Remarks</th>
        <th class="py-3 px-4 text-center">Action</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for req in all_requests %}
      <tr class="hover:bg-gray-50 transition">
        <td class="py-3 px-4 font-semibold text-nhc-blue">{{ req.user.username }}</td>
        <td class="py-3 px-4">{{ req.asset.get_asset_name_display }}</td>
        <td class="py-3 px-4">{{ req.asset.model|default:"N/A" }}</td>
        <td class="py-3 px-4">{{ req.request_date|date:"M d, Y" }}</td>
        <td class="py-3 px-4">{{ req.return_date|date:"M d, Y" }}</td>
        <td class="py-3 px-4">
          <span class="inline-block text-xs sm:text-sm font-medium px-3 py-1 rounded-full
            {% if req.status == 'approved' %}bg-green-100 text-green-700
            {% elif req.status == 'rejected' %}bg-red-100 text-red-700
            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
            {{ req.get_status_display }}
          </span>
        </td>
        <td class="py-3 px-4 text-gray-600 text-sm">
          {% if req.remarks %}{{ req.remarks }}{% else %}<span class="text-gray-400 italic">â€”</span>{% endif %}
        </td>
        <td class="py-3 px-4 text-center">
          {% if req.status == 'pending' %}
          <div class="flex justify-center gap-2">
            <button onclick="openActionModal({{ req.pk }}, 'approve')"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md transition text-xs sm:text-sm">
              Approve
            </button>
            <button onclick="openActionModal({{ req.pk }}, 'reject')"
              class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition text-xs sm:text-sm">
              Reject
            </button>
          </div>
          {% else %}
          <span class="text-gray-400 text-sm italic">No action</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination like Manage Returns -->
{% if page_obj.has_other_pages %}
<nav class="flex items-center justify-center mt-6 space-x-1">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}"
     class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Prev</a>
  {% else %}
  <span class="px-3 py-1 bg-gray-100 text-gray-400 rounded">&laquo; Prev</span>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
      {% if num == page_obj.number %}
        <span class="px-3 py-1 bg-nhc-blue text-white rounded">{{ num }}</span>
      {% else %}
        <a href="?page={{ num }}&search={{ search_query }}&status={{ status_filter }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}"
     class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next &raquo;</a>
  {% else %}
  <span class="px-3 py-1 bg-gray-100 text-gray-400 rounded">Next &raquo;</span>
  {% endif %}
</nav>
{% endif %}

{% else %}
<div class="bg-white p-6 rounded-xl shadow-md text-center">
  <p class="text-gray-600">No asset requests available at the moment.</p>
</div>
{% endif %}

<!-- Reuse your existing Action Modal -->
<div id="actionModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-start justify-center z-50 transition-opacity duration-300">
  <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md p-6 mt-10 transform scale-100 transition-all duration-200">
    <h3 class="text-lg font-semibold text-nhc-blue mb-4" id="modalTitle"></h3>
    <form method="POST" id="actionForm">{% csrf_token %}
      <div class="mb-4">
        <label for="remarks" class="block text-gray-700 font-medium">Remarks (optional)</label>
        <textarea name="remarks" id="remarks" rows="3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-nhc-yellow transition"></textarea>
      </div>
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeActionModal()" class="px-4 py-2 rounded-md bg-gray-300 hover:bg-gray-400 transition">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-md bg-nhc-blue text-white hover:bg-nhc-black transition" id="modalSubmitBtn">Confirm</button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts (Search + Filter + Modal) -->
<script>
  // Search
  document.querySelector('input[name="search"]').addEventListener('input', function(){
    // optional: client-side live search if needed
  });

  // Filter
  document.querySelector('select[name="status"]').addEventListener('change', function(){
    this.form.submit();
  });

  // Modal
  function openActionModal(requestId, action){
    document.getElementById('actionModal').classList.remove('hidden');
    document.getElementById('modalTitle').textContent = `${action.charAt(0).toUpperCase()+action.slice(1)} Request`;
    const form = document.getElementById('actionForm');
    form.action = `/requests/request/${requestId}/${action}/`;
    document.getElementById('modalSubmitBtn').textContent = action.charAt(0).toUpperCase()+action.slice(1);
  }
  function closeActionModal(){
    document.getElementById('actionModal').classList.add('hidden');
    document.getElementById('remarks').value='';
  }
</script>

{% endblock %}
