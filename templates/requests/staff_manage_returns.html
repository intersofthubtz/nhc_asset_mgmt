{% extends "accounts/staff_dashboard.html" %}
{% block staff_content %}

<div class="w-full max-w-7xl mx-auto mt-6 px-4 sm:px-6 lg:px-8">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <h2 class="text-2xl sm:text-3xl font-bold text-nhc-blue tracking-tight">Manage Asset Returns</h2>
  </div>

  <!-- Search & Filters -->
  <form id="searchForm" method="get"
        class="flex flex-col sm:flex-row items-center justify-between gap-3 mb-5 bg-white p-4 rounded-lg shadow-md border border-gray-100">

    <div class="w-full sm:w-1/2">
      <input type="text" name="search" value="{{ search_query }}"
             placeholder="Search by user, asset, serial..."
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-nhc-blue shadow-sm">
    </div>

    <select name="condition"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-nhc-blue w-full sm:w-40">
      <option value="all" {% if condition_filter == 'all' %}selected{% endif %}>All Conditions</option>
      <option value="good" {% if condition_filter == 'good' %}selected{% endif %}>Good</option>
      <option value="fair" {% if condition_filter == 'fair' %}selected{% endif %}>Fair</option>
      <option value="damaged" {% if condition_filter == 'damaged' %}selected{% endif %}>Damaged</option>
      <option value="lost" {% if condition_filter == 'lost' %}selected{% endif %}>Lost</option>
    </select>
  </form>

  <!-- Table -->
  <div class="overflow-x-auto bg-white shadow-md rounded-none">
    <table class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">
      <thead class="bg-gray-200 text-nhc-black uppercase font-semibold">
        <tr>
          <th class="py-3 px-4 text-left">User</th>
          <th class="py-3 px-4 text-left">Asset Category</th>
          <th class="py-3 px-4 text-left">Assigned Asset</th>
          <th class="py-3 px-4 text-left">Returned Date</th>
          <th class="py-3 px-4 text-left">Condition</th>
          <th class="py-3 px-4 text-left">Received By</th>
          <th class="py-3 px-4 text-center">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        {% for ret in page_obj %}
        <tr class="hover:bg-gray-50 transition duration-150">

          <td class="py-3 px-4 font-semibold text-nhc-blue">
            {{ ret.borrow_request.user.username }}
          </td>

          <td class="py-3 px-4">
            {{ ret.borrow_request.asset_category }}
          </td>

          <td class="py-3 px-4">
            {% if ret.borrow_request.assigned_asset %}
              <div class="font-semibold text-nhc-blue">
                {{ ret.borrow_request.assigned_asset.model }}
              </div>
              <div class="text-gray-500 text-xs">
                Serial: {{ ret.borrow_request.assigned_asset.serial_number }}
              </div>
            {% else %}
              <span class="text-gray-400">—</span>
            {% endif %}
          </td>

          <td class="py-3 px-4">
            {{ ret.returned_date|date:"M d, Y H:i" }}
          </td>

          <td class="py-3 px-4">
            <span class="inline-flex items-center px-3 py-1 font-semibold rounded-full
              {% if ret.condition_on_return == 'good' %}bg-green-100 text-green-700
              {% elif ret.condition_on_return == 'fair' %}bg-yellow-100 text-yellow-700
              {% elif ret.condition_on_return == 'damaged' %}bg-red-100 text-red-700
              {% elif ret.condition_on_return == 'lost' %}bg-gray-300 text-gray-700{% endif %}">
              {{ ret.get_condition_on_return_display }}
            </span>
          </td>

          <td class="py-3 px-4">
            {{ ret.received_by.username|default:"—" }}
          </td>

          <!-- ACTIONS -->
          <td class="py-3 px-4 flex justify-center gap-4">

            <!-- View Return Details -->
            <a href="{% url 'requests:staff_return_detail' ret.pk %}"
               class="text-blue-600 hover:text-blue-900" title="View Details">
              <i class="fas fa-eye"></i>
            </a>

            {% if not ret.returned_date %}
              <!-- Mark as Returned ONLY if not returned -->
              <button onclick="openReturnModal('{{ ret.borrow_request.pk }}')"
                 class="text-green-600 hover:text-green-900" title="Mark as Fully Returned">
                <i class="fas fa-check-circle"></i>
              </button>
            {% else %}
              <!-- Already returned badge -->
              <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                ✔ Returned
              </span>
            {% endif %}
          </td>

        </tr>

        {% empty %}
        <tr>
          <td colspan="7" class="py-8 text-center text-gray-500">No returned assets found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
  <nav class="flex justify-center items-center mt-6 gap-2 text-sm sm:text-base">

    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&condition={{ condition_filter }}"
         class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">Previous</a>
    {% else %}
      <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">Previous</span>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if num == page_obj.number %}
        <span class="px-4 py-2 bg-nhc-yellow text-nhc-black rounded-md font-semibold shadow">{{ num }}</span>
      {% elif num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
        <a href="?page={{ num }}&search={{ search_query }}&condition={{ condition_filter }}"
           class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">
          {{ num }}
        </a>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&condition={{ condition_filter }}"
         class="px-4 py-2 bg-nhc-blue text-white rounded-md hover:bg-nhc-yellow hover:text-nhc-black transition">Next</a>
    {% else %}
      <span class="px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">Next</span>
    {% endif %}
  </nav>
  {% endif %}
</div>

<!-- ========================== -->
<!-- RETURN MODAL -->
<!-- ========================== -->
<div id="returnModal"
     class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden justify-center items-center z-50">

  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md relative">

    <h2 class="text-xl font-bold mb-4 text-nhc-blue">Mark Asset as Returned</h2>

    <form id="returnForm" method="POST">
      {% csrf_token %}

      <label class="block mb-2 font-semibold">Return Date</label>
      <input type="datetime-local" name="returned_date"
             class="w-full border px-3 py-2 rounded mb-4" required>

      <label class="block mb-2 font-semibold">Condition</label>
      <select name="condition_on_return"
              class="w-full border px-3 py-2 rounded mb-4" required>
        <option value="good">Good</option>
        <option value="fair">Fair</option>
        <option value="damaged">Damaged</option>
        <option value="lost">Lost</option>
      </select>

      <label class="block mb-2 font-semibold">Remarks</label>
      <textarea name="remarks" class="w-full border px-3 py-2 rounded mb-4"
                placeholder="Enter remarks (optional)"></textarea>

      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeReturnModal()"
                class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>

        <button type="submit"
                class="px-4 py-2 bg-nhc-blue text-white rounded hover:bg-nhc-yellow hover:text-black">
          Submit
        </button>
      </div>
    </form>
  </div>

</div>

<script>
function openReturnModal(reqId) {
    const form = document.getElementById("returnForm");
    form.action = "/requests/mark-returned/" + reqId + "/";  
    document.getElementById("returnModal").classList.remove("hidden");
}

function closeReturnModal() {
    document.getElementById("returnModal").classList.add("hidden");
}

const searchForm = document.getElementById('searchForm');
const searchInput = document.querySelector('input[name="search"]');
const conditionSelect = document.querySelector('select[name="condition"]');

let typingTimer;
const delay = 500;

searchInput.addEventListener('keyup', () => {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => searchForm.submit(), delay);
});

conditionSelect.addEventListener('change', () => searchForm.submit());
</script>

{% endblock %}
