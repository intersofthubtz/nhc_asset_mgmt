{% extends "accounts/admin_dashboard.html" %}
{% block admin_content %}
<h2 class="text-2xl font-bold text-nhc-blue mb-3">Manage Returned Assets</h2>
<p class="text-gray-700 mb-6">Review assets returned by users and record their condition.</p>

<!-- Search + Filters -->
<form method="get" class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 w-full">

  <!-- Search Input -->
  <input
    type="text"
    name="search"
    value="{{ search_query }}"
    placeholder="Search by user, asset, model, or remarks..."
    class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nhc-yellow"
    oninput="this.form.submit()"
  />

  <!-- Condition -->
  <div class="flex items-center gap-2">
    <select
      name="condition"
      class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-nhc-yellow"
      onchange="this.form.submit()"
    >
        <option value="all" {% if condition_filter == "all" %}selected{% endif %}>All</option>
        <option value="good" {% if condition_filter == "good" %}selected{% endif %}>Good</option>
        <option value="damaged" {% if condition_filter == "damaged" %}selected{% endif %}>Damaged</option>
        <option value="lost" {% if condition_filter == "lost" %}selected{% endif %}>Lost</option>
        <option value="not returned" {% if condition_filter == "not returned" %}selected{% endif %}>Not Returned</option>
    </select>
  </div>

</form>

<!-- Returned Assets Table -->
<div class="overflow-x-auto bg-white shadow-md rounded-none">
  <table class="min-w-full divide-y divide-gray-200 text-sm" id="returnsTable">
    <thead class="bg-gray-200 text-nhc-black uppercase font-semibold">
      <tr>
        <th class="py-3 px-4 text-left">User</th>
        <th class="py-3 px-4 text-left">Asset</th>
        <th class="py-3 px-4 text-left">Model</th>
        <th class="py-3 px-4 text-left">Expected Return</th>
        <th class="py-3 px-4 text-left">Condition</th>
        <th class="py-3 px-4 text-left">Returned Date</th>
        <th class="py-3 px-4 text-left">Remarks</th>
        <th class="py-3 px-4 text-left">Received By</th>
        <th class="py-3 px-4 text-left">Action</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-gray-100">
      {% for req in page_obj %}
      {% with return=req.returns.first %}
      <tr class="hover:bg-gray-50 transition">
        <td class="py-3 px-4 font-semibold text-nhc-blue">{{ req.user.username }}</td>
        <td class="py-3 px-4">{{ req.asset.asset_name }}</td>
        <td class="py-3 px-4">{{ req.asset.model|default:"N/A" }}</td>
        <td class="py-3 px-4">{{ req.return_date|date:"M d, Y" }}</td>

        <!-- Condition -->
        <td class="py-3 px-4">
          {% if return %}
            <span class="inline-block px-3 py-1 bg-gray-100 text-gray-800 rounded">
              {{ return.condition_on_return|capfirst }}
            </span>
          {% else %}
            <span class="inline-block px-3 py-1 bg-gray-100 text-gray-500 rounded">Not Returned</span>
          {% endif %}
        </td>

        <!-- Returned Date -->
        <td class="py-3 px-4">
          {% if return %}
            {{ return.returned_date|date:"M d, Y" }}
          {% else %}
            -
          {% endif %}
        </td>

        <!-- Remarks -->
        <td class="py-3 px-4">
          {% if return %}
            {{ return.remarks|default:"-" }}
          {% else %}
            -
          {% endif %}
        </td>

        <!-- Received By -->
        <td class="py-3 px-4">
          {% if return %}
            {{ return.received_by.username }}
          {% else %}
            -
          {% endif %}
        </td>

        <!-- Action Button -->
        <td class="py-3 px-4">
          {% if not return %}
            <button
              type="button"
              class="px-3 py-1 bg-nhc-blue text-white rounded-md text-sm mark-return-btn"
              data-req-id="{{ req.id }}"
              data-user="{{ req.user.username }}"
              data-asset="{{ req.asset.asset_name }}"
            >
              Mark Returned
            </button>
          {% else %}
            <span class="text-gray-500 text-sm">Returned</span>
          {% endif %}
        </td>
      </tr>
      {% endwith %}
      {% empty %}
      <tr>
        <td colspan="8" class="text-center text-gray-500 py-4">No results found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- PAGINATION -->
{% if page_obj.has_other_pages %}
<nav class="flex items-center justify-center mt-6 space-x-1">

  {% if page_obj.has_previous %}
  <a
    href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&condition={{ condition_filter }}"
    class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
  >&laquo; Prev</a>
  {% else %}
  <span class="px-3 py-1 bg-gray-100 text-gray-400 rounded">&laquo; Prev</span>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if num == page_obj.number %}
      <span class="px-3 py-1 bg-nhc-blue text-white rounded">{{ num }}</span>
    {% else %}
      <a
        href="?page={{ num }}&search={{ search_query }}&condition={{ condition_filter }}"
        class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
      >{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
  <a
    href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&condition={{ condition_filter }}"
    class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
  >Next &raquo;</a>
  {% else %}
  <span class="px-3 py-1 bg-gray-100 text-gray-400 rounded">Next &raquo;</span>
  {% endif %}

</nav>
{% endif %}


<!-- (âš  Keep your modal + JS for marking return - unchanged) -->
<div id="returnModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 mx-4">
    <h2 class="text-xl font-bold mb-4 text-center text-nhc-blue">Mark Asset as Returned</h2>

    <form id="returnForm" method="POST" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="req_id" id="modalReqId">

      <div>
        <label class="block text-sm font-medium mb-1">User</label>
        <input type="text" id="modalUser" class="w-full border px-3 py-2 rounded bg-gray-100" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Asset</label>
        <input type="text" id="modalAsset" class="w-full border px-3 py-2 rounded bg-gray-100" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Condition</label>
        <select name="condition" class="w-full border px-3 py-2 rounded" required>
          <option value="good">Good</option>
          <option value="damaged">Damaged</option>
          <option value="lost">Lost</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Returned Date</label>
        <input type="date" name="returned_date" value="{{ today|date:'Y-m-d' }}" class="w-full border px-3 py-2 rounded" required>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Remarks</label>
        <textarea name="remarks" class="w-full border px-3 py-2 rounded" rows="2" placeholder="Enter remarks..."></textarea>
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <button type="button" onclick="closeReturnModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-nhc-blue text-white rounded hover:bg-blue-700">Submit</button>
      </div>
    </form>
  </div>
</div>


<!-- ===================== JS ========================= -->
<script>
// Open modal
document.querySelectorAll('.mark-return-btn').forEach(btn => {
  btn.addEventListener('click', function(){
    const reqId = this.dataset.reqId;
    const user = this.dataset.user;
    const asset = this.dataset.asset;

    document.getElementById('modalReqId').value = reqId;
    document.getElementById('modalUser').value = user;
    document.getElementById('modalAsset').value = asset;

    document.getElementById('returnModal').classList.remove('hidden');
    document.getElementById('returnModal').classList.add('flex');
  });
});

// Close modal
function closeReturnModal(){
  const modal = document.getElementById('returnModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// Feedback toast helper
function showFeedback(message, type="success"){
  let existing = document.getElementById("feedbackMessage");
  if(existing) existing.remove();

  const div = document.createElement("div");
  div.id = "feedbackMessage";
  div.innerText = message;
  div.className = `
    fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white
    ${type === "success" ? "bg-green-500" : "bg-red-500"}
  `;
  document.body.appendChild(div);

  setTimeout(() => div.remove(), 3000);
}

// AJAX submit
document.getElementById("returnForm").addEventListener("submit", function(e){
  e.preventDefault();
  const form = e.target;
  const reqId = document.getElementById('modalReqId').value;
  const formData = new FormData(form);

  fetch("{% url 'requests:admin_mark_returned' 0 %}".replace("0", reqId), {
    method: 'POST',
    headers: {'X-Requested-With': 'XMLHttpRequest'},
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      const row = document.querySelector(`button[data-req-id='${reqId}']`).closest("tr");

      // Update table row
      row.querySelector("td:nth-child(5)").innerHTML =
        `<span class='inline-block px-3 py-1 bg-gray-100 text-gray-800 rounded'>${data.condition}</span>`;
      row.querySelector("td:nth-child(6)").innerText = data.returned_date;
      row.querySelector("td:nth-child(7)").innerText = data.remarks || "-";
      row.querySelector("td:nth-child(8)").innerHTML = '<span class="text-gray-500 text-sm">Returned</span>';

      // Show feedback toast
      showFeedback("Asset marked as returned successfully!", "success");

      closeReturnModal();
    } else if(data.error){
      showFeedback(data.error, "error");
    }
  })
  .catch(err => {
    showFeedback("An unexpected error occurred.", "error");
  });
});
</script>

{% endblock %}
